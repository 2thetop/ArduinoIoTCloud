# ArduinoIoTCloud

This library allows to connect to the Arduino IoT Cloud service. It provides a ConnectionManager to handle connection/disconnection, property-change updates and events callbacks.
The supported boards are MKRGSM, MKR1000 (WiFi101) and MKR 1010 (WiFiNINA).

## Arduino IoT Cloud

[Arduino IoT Cloud](https://create.arduino.cc/iot/things) is a service which allows connecting the cloud to the world around you. [Here](https://www.arduino.cc/en/IoT/HomePage) is an introduction.
Now the platform is in public beta, feedback is welcome.


### Arduino IoT Cloud Components

- **Devices**: Physical objects like a hardware board (e.g. MKR WiFi 1010). This is the hardware which runs the software, reads sensors, controls actuators and communicates with the Arduino IoT Cloud.

- **Things**: Logical representation of a connected object. They represent the inherent properties of the object, with as little reference to the actual hardware used to implement them. Each thing is represented by a collection of properties (e.g., temperature, light).

- **Properties**: Qualities defining the characteristics of a system. A property can be something like a read-only (RO) setting to indicate the Arduino IoT Cloud can read the data, but cannot change the value of the property. A property might be designed as read and write (RW) if the Arduino IoT Cloud can also remotely change the propertyâ€™s value and send an event notification to the device.

- **Events**: When something happens the Arduino IoT Cloud is aware of it thanks to application messages. For example, it might be informed by a face-recognition application that someone is at a door, or it has received a request from another app that a light be turned on.

- **Software**: It's quickly autogenerated automatically by the Arduino IoT Cloud when setting up a new thing: in this way, almost everything that you need is done and ready. The connection to the cloud is handled by this library. You have only to implement the callbacks linked to the properties.

## ArduinoIoTCloud library

The library is divided into various classes:
- `ConnectionManager` which is responsable for the connection to the Internet through `WiFiConnectionManager` or `GSMConnectionManager`. The selection is done using the type of board used.

- `ArduinoIoTCloud` it's the leading class. It's responsible for the connection to the MQTT Broker and to the Arduino IoT Cloud.

- `CloudSerial` it's similar to [Serial](https://www.arduino.cc/reference/en/language/functions/communication/serial/), but used in combination with the cloud.

### ConnectionManager

*Connection Manager* is capable of knowing which board is being used through some `ifdef`.

- Instantiate the class with `ConnectionManager *ArduinoIoTPreferredConnection = new WiFiConnectionManager(SECRET_SSID, SECRET_PASS);` if you are using a WiFi board

- `check()` function does all the job. It uses a finite state machine and it's responsible for the connection and reconnection to the Internet. The function is non blocking thanks to *millis*

- `getTime()` function actually return the time from a NTP server. It's used for the connection to the cloud

- `&getClient()` returns the client

- `	getStatus()` returns the network connection status

- `debugMessage(char *_msg, uint8_t _debugLevel)` function used to print debug messages on the serial

- The `setDebugMessageLevel(uint8_t _debugLevel)` function is used to set a debug level. Every debug message comes with a level which goes from 0 to 4. Higher level means higher verbosity. Debug messages with level higher than `_debugLevel` will not been showed.

### ArduinoIoTCloud

- The `begin(ConnectionManager *connection = ArduinoIoTPreferredConnection, String brokerAddress = "mqtts-sa.iot.arduino.cc")` function is used to initialize the connection to the Arduino IoT Cloud through MQTT

- The `connect()` function is used to connect to the MQTT broker

- `disconnect()` stops the MQTT Client

- The `update()` function is called periodically in the loop of `.ino` file. It checks the connnection with the MQTT broker, retrieve data from the Cloud and pushes back data using function `writeProperties(const byte data[], int length)`.

- `connected()` simply returns the current status of the MQTT connection.

- `reconnect(Client&)` clean up existing MQTT connection, create a new one and initialize it by calling `connect()`

- `setThingId(String const thing_id)` sets the *THING_ID*

- `getThingId()` returns the *THING_ID*

- `connectionCheck()` function is like `check()` from *ConnectionManager*. Uses a finite state machine and it's responsible for the connection to Arduino IoT Cloud. It also uses *debugMessage* from *ConnectionManager* to print debug messages.